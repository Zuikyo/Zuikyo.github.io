<!doctype html>



  


<html class="theme-next pisces use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/libs/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/libs/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="iOS," />





  <link rel="alternate" href="/atom.xml" title="é»‘è¶…ç†ŠçŒ«zuik's blog" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta name="description" content="å¦‚æœä½ è¿˜ä¸äº†è§£ä»€ä¹ˆæ˜¯runloopï¼Œå¯ä»¥çœ‹è¿™é‡Œçš„è¯¦è§£æ·±å…¥ç†è§£RunLoopã€‚
è‹¹æœå®˜æ–¹æ–‡æ¡£ä¸­ï¼Œå£°æ˜äº†CFRunloopæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼š

Thread safety varies depending on which API you are using to manipulate your run loop. The functions in Core Foundation are generall">
<meta property="og:type" content="article">
<meta property="og:title" content="CFRunloopçš„å¤šçº¿ç¨‹éšæ‚£">
<meta property="og:url" content="http://yoursite.com/2017/05/22/CFRunloopçš„å¤šçº¿ç¨‹éšæ‚£/index.html">
<meta property="og:site_name" content="é»‘è¶…ç†ŠçŒ«zuik's blog">
<meta property="og:description" content="å¦‚æœä½ è¿˜ä¸äº†è§£ä»€ä¹ˆæ˜¯runloopï¼Œå¯ä»¥çœ‹è¿™é‡Œçš„è¯¦è§£æ·±å…¥ç†è§£RunLoopã€‚
è‹¹æœå®˜æ–¹æ–‡æ¡£ä¸­ï¼Œå£°æ˜äº†CFRunloopæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼š

Thread safety varies depending on which API you are using to manipulate your run loop. The functions in Core Foundation are generall">
<meta property="og:updated_time" content="2017-08-13T07:25:24.120Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="CFRunloopçš„å¤šçº¿ç¨‹éšæ‚£">
<meta name="twitter:description" content="å¦‚æœä½ è¿˜ä¸äº†è§£ä»€ä¹ˆæ˜¯runloopï¼Œå¯ä»¥çœ‹è¿™é‡Œçš„è¯¦è§£æ·±å…¥ç†è§£RunLoopã€‚
è‹¹æœå®˜æ–¹æ–‡æ¡£ä¸­ï¼Œå£°æ˜äº†CFRunloopæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼š

Thread safety varies depending on which API you are using to manipulate your run loop. The functions in Core Foundation are generall">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: 'åšä¸»'
    }
  };
</script>




  <link rel="canonical" href="http://yoursite.com/2017/05/22/CFRunloopçš„å¤šçº¿ç¨‹éšæ‚£/"/>

  <title> CFRunloopçš„å¤šçº¿ç¨‹éšæ‚£ | é»‘è¶…ç†ŠçŒ«zuik's blog </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">é»‘è¶…ç†ŠçŒ«zuik's blog</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">å†™ç‚¹åˆ«äººæ²¡å†™è¿‡çš„</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            é¦–é¡µ
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            åˆ†ç±»
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            å½’æ¡£
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            æ ‡ç­¾
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                CFRunloopçš„å¤šçº¿ç¨‹éšæ‚£
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">å‘è¡¨äº</span>
            <time itemprop="dateCreated" datetime="2017-05-22T16:29:29+08:00" content="2017-05-22">
              2017-05-22
            </time>
          </span>

          

          
            
          

          

          
          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>å¦‚æœä½ è¿˜ä¸äº†è§£ä»€ä¹ˆæ˜¯runloopï¼Œå¯ä»¥çœ‹è¿™é‡Œçš„è¯¦è§£<a href="http://blog.ibireme.com/2015/05/18/runloop/" target="_blank" rel="external">æ·±å…¥ç†è§£RunLoop</a>ã€‚</p>
<p>è‹¹æœ<a href="https://developer.apple.com/library/content/documentation/Cocoa/Conceptual/Multithreading/RunLoopManagement/RunLoopManagement.html#//apple_ref/doc/uid/10000057i-CH16-SW26" target="_blank" rel="external">å®˜æ–¹æ–‡æ¡£</a>ä¸­ï¼Œå£°æ˜äº†CFRunloopæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼š</p>
<blockquote>
<p>Thread safety varies depending on which API you are using to manipulate your run loop. The functions in Core Foundation are <strong><em>generally</em></strong> thread-safe and can be called from any thread. If you are performing operations that alter the configuration of the run loop, however, it is still good practice to do so from the thread that owns the run loop whenever possible.</p>
</blockquote>
<p>ä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç‹¡çŒ¾çš„è‹¹æœä½¿ç”¨äº†<code>generally</code>è¿™ä¸ªæ¨¡ç³Šçš„è¯ã€‚</p>
<p>ä»å®è·µä¸­æ¥çœ‹ï¼ŒCFRunloopåœ¨åœæ­¢runloopçš„é˜¶æ®µçš„æŸäº›æ“ä½œæ˜¯å­˜åœ¨å¤šçº¿ç¨‹éšæ‚£çš„ã€‚</p>
<h2 id="ä¸å®‰å…¨çš„CFRunloopSource"><a href="#ä¸å®‰å…¨çš„CFRunloopSource" class="headerlink" title="ä¸å®‰å…¨çš„CFRunloopSource"></a>ä¸å®‰å…¨çš„CFRunloopSource</h2><p>CFRunloopæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä½†æ˜¯åŠ ä¸ŠCFRunloopSourceå°±ä¸ä¸€å®šäº†ã€‚æ¯”å¦‚CFSocketã€‚</p>
<h3 id="ç¤ºä¾‹ä»£ç "><a href="#ç¤ºä¾‹ä»£ç " class="headerlink" title="ç¤ºä¾‹ä»£ç "></a>ç¤ºä¾‹ä»£ç </h3><p>çœ‹è¿™æ ·ä¸€æ®µè‡ªå®šä¹‰çº¿ç¨‹çš„ä»£ç ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div></pre></td><td class="code"><pre><div class="line">@interface MyThread()</div><div class="line">@property (nonatomic, strong) NSThread *currentThread;</div><div class="line">@property (nonatomic, assign) CFRunLoopSourceRef socketSource;</div><div class="line">@property (nonatomic, assign) CFSocketRef socket;</div><div class="line">@property (nonatomic, assign) CFRunLoopRef currentRunloop;</div><div class="line"></div><div class="line">@end</div><div class="line"></div><div class="line">@implementation MyThread</div><div class="line"></div><div class="line">//åˆå§‹åŒ–çº¿ç¨‹</div><div class="line">- (instancetype)init &#123;</div><div class="line">    if (self = [super init]) &#123;</div><div class="line">        _currentThread = [[NSThread alloc] initWithTarget:self selector:@selector(runThread) object:nil];</div><div class="line">    &#125;</div><div class="line">    return self;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//å¼€å¯çº¿ç¨‹ï¼›æ­¤æ–¹æ³•åœ¨ä½¿ç”¨æ—¶æ²¡æœ‰å¤šçº¿ç¨‹è°ƒç”¨</div><div class="line">- (void)startThread &#123;</div><div class="line">    [self.currentThread start];</div><div class="line">&#125;</div><div class="line"></div><div class="line">//çº¿ç¨‹å…¥å£</div><div class="line">- (void)runThread &#123;</div><div class="line">    @autoreleasepool &#123;</div><div class="line">    //è¿”å›runloopï¼Œå¯ä»¥è®©å…¶ä»–çº¿ç¨‹åœæ­¢æ­¤çº¿ç¨‹</div><div class="line">        self.currentRunloop = CFRunLoopGetCurrent();</div><div class="line">        [self addSocketSource];</div><div class="line">        </div><div class="line">        CFRunLoopRun();</div><div class="line">    &#125;</div><div class="line">    NSLog(@&quot;çº¿ç¨‹é€€å‡º&quot;);</div><div class="line">&#125;</div><div class="line"></div><div class="line">//æ­¤æ–¹æ³•åœ¨ä½¿ç”¨æ—¶æ²¡æœ‰å¤šçº¿ç¨‹è°ƒç”¨</div><div class="line">- (void)stopThread &#123;</div><div class="line">true [self removeSocketSource];</div><div class="line">true @synchronized (_currentRunloop) &#123;</div><div class="line">        if (_currentRunloop) &#123;</div><div class="line">true        CFRunLoopStop(_currentRunloop);</div><div class="line">true        self.currentRunloop = NULL;</div><div class="line">true    &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//æ­¤æ–¹æ³•åœ¨ä½¿ç”¨æ—¶æ²¡æœ‰å¤šçº¿ç¨‹è°ƒç”¨</div><div class="line">- (void)addSocketSource &#123;</div><div class="line">    int sock;</div><div class="line">    sock = socket(AF_INET6, SOCK_STREAM, 0);</div><div class="line">    CFSocketContext context = &#123;0, (__bridge void *)(self), NULL, NULL, NULL&#125;;</div><div class="line">    self.socket = CFSocketCreateWithNative(NULL, sock, kCFSocketReadCallBack, socketCallBack, &amp;context);</div><div class="line">    self.socketSource = CFSocketCreateRunLoopSource(NULL, self.socket, 0);</div><div class="line">    CFRunLoopAddSource(_currentRunloop, _socketSource, kCFRunLoopDefaultMode);</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (void)removeSocketSource &#123;</div><div class="line">true@synchronized (_socket) &#123;</div><div class="line">truetrueif (_socket) &#123;</div><div class="line">truetruetrue//CFSocketInvalidateå¯èƒ½è¢«æŠ›åˆ°å¦ä¸€ä¸ªçº¿ç¨‹å»æ‰§è¡Œï¼Œå› æ­¤ CFSocketInvalidate å’Œ CFRunLoopStopå¯èƒ½æœ‰å¤šçº¿ç¨‹åŒæ—¶è°ƒç”¨çš„æƒ…å†µ       </div><div class="line">true        CFSocketInvalidate(_socket);</div><div class="line">true        CFRelease(_socket);</div><div class="line">true        self.socket = NULL;</div><div class="line">true    &#125;</div><div class="line">true&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åœ¨å®è·µä¸­ï¼ŒCFSocketæ˜¯è¢«å¦ä¸€ä¸ªsocketç±»ç®¡ç†çš„ï¼Œæ‰€ä»¥<code>addSocketSource</code>å’Œ<code>removeSocketSource</code>éƒ½æ˜¯åœ¨å¦ä¸€ä¸ªç±»ä¸­çš„ï¼Œä¹Ÿå°±æœ‰å¯èƒ½å‡ºç°<code>CFSocketInvalidate</code>å’Œ <code>CFRunLoopStop</code>å¤šçº¿ç¨‹åŒæ—¶è°ƒç”¨çš„æƒ…å†µã€‚</p>
<h3 id="crashå®ä¾‹åˆ†æ"><a href="#crashå®ä¾‹åˆ†æ" class="headerlink" title="crashå®ä¾‹åˆ†æ"></a>crashå®ä¾‹åˆ†æ</h3><p>çœ‹ä¸Šå»å¹¶æ²¡æœ‰ä»€ä¹ˆé—®é¢˜ï¼Œè¯¥åŠ é”çš„åœ°æ–¹éƒ½åŠ é”äº†ï¼Œè€Œä¸”CFå¼€å¤´çš„é‚£å‡ ä¸ªæ–¹æ³•éƒ½æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚ä½†æ˜¯è¿™æ—¶å€™ï¼Œå¦‚æœå‡ºç°<code>CFSocketInvalidate</code>å’Œ <code>CFRunLoopStop</code>å¤šçº¿ç¨‹åŒæ—¶è°ƒç”¨çš„æƒ…å†µï¼Œå°±æœ‰crashçš„å¯èƒ½ã€‚ä¾‹å¦‚æˆ‘ä»¬é¡¹ç›®é‡Œæ”¶åˆ°çš„æŸä¸ªcrashï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">Thread 0 name:  Dispatch queue: com.apple.main-thread</div><div class="line">Thread 0 Crashed:</div><div class="line">0   CoreFoundation                  0x000000018e6a9144 CFRunLoopWakeUp + 92</div><div class="line">1   CoreFoundation                  0x000000018e6a9140 CFRunLoopWakeUp + 88</div><div class="line">2   CoreFoundation                  0x000000018e6d71e8 CFSocketInvalidate + 712</div><div class="line">3   MyApp                           0x00000001000fe424 (-[MySocket stop] + 136)</div><div class="line">4   MyApp                           0x00000001000fcd50 (-[MySocket dealloc] + 56)</div><div class="line">5   libsystem_blocks.dylib          0x000000018d6afa28 _Block_release + 144</div><div class="line">6   libdispatch.dylib               0x000000018d65a1bc _dispatch_client_callout + 16</div><div class="line">7   libdispatch.dylib               0x000000018d65ed68 _dispatch_main_queue_callback_4CF + 1000</div><div class="line">8   CoreFoundation                  0x000000018e77e810 __CFRUNLOOP_IS_SERVICING_THE_MAIN_DISPATCH_QUEUE__ + 12</div><div class="line">9   CoreFoundation                  0x000000018e77c3fc __CFRunLoopRun + 1660</div><div class="line">10  CoreFoundation                  0x000000018e6aa2b8 CFRunLoopRunSpecific + 444</div><div class="line">11  GraphicsServices                0x000000019015e198 GSEventRunModal + 180</div><div class="line">12  UIKit                           0x00000001946f17fc -[UIApplication _run] + 684</div><div class="line">13  UIKit                           0x00000001946ec534 UIApplicationMain + 208</div><div class="line">14  DuoYiIM                         0x000000010003ca58 0x100024000 + 100952 (main + 132)</div><div class="line">15  libdyld.dylib                   0x000000018d68d5b8 start + 4</div><div class="line"></div><div class="line">Thread 0 crashed with ARM-64 Thread State:</div><div class="line">  cpsr: 0x0000000020000000     fp: 0x000000016fddab30     lr: 0x000000018e6a9140     pc: 0x000000018e6a9144 </div><div class="line">    sp: 0x000000016fddaa00     x0: 0x0000000000000000     x1: 0x0000000000000000    x10: 0x0000000000000000 </div><div class="line">   x11: 0x0000000000000000    x12: 0x0000000000000000    x13: 0x0000000000000000    x14: 0x0000000000000000 </div><div class="line">   x15: 0x0000000000001203    x16: 0x000000000000012d    x17: 0x000000018f1eef74    x18: 0x0000000000000000 </div><div class="line">   x19: 0x000000017056cb50     x2: 0x0000000000001000    x20: 0x000000017056cb40    x21: 0x96e73914144e0055 </div><div class="line">   x22: 0x0000000174452990    x23: 0x000000017048bae0    x24: 0x0000000000000000    x25: 0x00000000ffffffff </div><div class="line">   x26: 0xffffffffffffffff    x27: 0x000000017426f1c0    x28: 0x0000000002ffffff    x29: 0x000000016fddab30 </div><div class="line">    x3: 0x000000000017e4a6     x4: 0x0000000000012068     x5: 0x0000000000000000     x6: 0x0000000000000036 </div><div class="line">    x7: 0xffffffffffffffec     x8: 0x8c8c8c8c8c8c8c8c     x9: 0x000000000000000c</div></pre></td></tr></table></figure>
<p><code>CFSocketInvalidate</code>åœ¨ä¸»çº¿ç¨‹è¢«è°ƒç”¨äº†ã€‚çœ‹å †æ ˆï¼Œåœ¨<code>CFSocketInvalidate</code>å†…éƒ¨è°ƒç”¨<code>CFRunLoopWakeUp</code>æ—¶ï¼Œå‡ºç°äº†crashã€‚</p>
<p>çœ‹ä¸å‡ºå…·ä½“æ˜¯ä»€ä¹ˆåŸå› crashï¼Œæ‰€ä»¥éœ€è¦çœ‹çœ‹æ˜¯åœ¨<code>CFRunLoopWakeUp</code>çš„å“ªé‡ŒæŒ‚çš„ã€‚æŸ¥çœ‹å¯¹åº”ç‰ˆæœ¬çš„<code>CoreFoundation</code>çš„æ±‡ç¼–ä»£ç ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">_CFRunLoopWakeUp:</div><div class="line">0x0000000181521b9c FF0305D1               sub        sp, sp, #0x140             ; CODE XREF=_CFRunLoopAddTimer+696, _CFRunLoopTimerSetNextFireDate+592, _CFSocketInvalidate+708, __wakeUpRunLoop+276, __CFXRegistrationPost+344, -[CFPrefsSearchListSource asynchronouslyNotifyOfChangesFromDictionary:toDictionary:]+172, ___CFSocketPerformV0+1408, ___CFSocketManager+2004, ___CFSocketManager+4248, _boundPairRead+604, _boundPairReadClose+124, â€¦</div><div class="line">0x0000000181521ba0 FC6F11A9               stp        x28, x27, [sp, #0x110]</div><div class="line">0x0000000181521ba4 F44F12A9               stp        x20, x19, [sp, #0x120]</div><div class="line">0x0000000181521ba8 FD7B13A9               stp        x29, x30, [sp, #0x130]</div><div class="line">0x0000000181521bac FDC30491               add        x29, sp, #0x130</div><div class="line">0x0000000181521bb0 F40300AA               mov        x20, x0</div><div class="line">0x0000000181521bb4 C80C10F0               adrp       x8, #0x1a16bc000</div><div class="line">0x0000000181521bb8 084140F9               ldr        x8, [x8, #0x80]            ; -[_CFXPreferences init]_1a16bc080</div><div class="line">0x0000000181521bbc 080140F9               ldr        x8, [x8]</div><div class="line">0x0000000181521bc0 292013F0               adrp       x9, #0x1a7928000</div><div class="line">0x0000000181521bc4 29E90791               add        x9, x9, #0x1fa             ; ___CF120290</div><div class="line">0x0000000181521bc8 A8831DF8               stur       x8, [x29, #-0x28]</div><div class="line">0x0000000181521bcc E8030032               orr        w8, wzr, #0x1</div><div class="line">0x0000000181521bd0 28010039               strb       w8, [x9]                   ; ___CF120290</div><div class="line">0x0000000181521bd4 E8731290               adrp       x8, #0x1a639d000</div><div class="line">0x0000000181521bd8 08F13F91               add        x8, x8, #0xffc             ; ___CF120293</div><div class="line">0x0000000181521bdc 08014039               ldrb       w8, [x8]                   ; ___CF120293</div><div class="line">0x0000000181521be0 48000034               cbz        w8, loc_181521be8</div><div class="line"></div><div class="line">0x0000000181521be4 E3560394               bl         ___THE_PROCESS_HAS_FORKED_AND_YOU_CANNOT_USE_THIS_COREFOUNDATION_FUNCTIONALITY___YOU_MUST_EXEC__</div><div class="line"></div><div class="line">                                      loc_181521be8:</div><div class="line">0x0000000181521be8 93420091               add        x19, x20, #0x10            ; CODE XREF=_CFRunLoopWakeUp+68</div><div class="line">0x0000000181521bec E00313AA               mov        x0, x19</div><div class="line">0x0000000181521bf0 70300694               bl         imp___stubs_-[NSOrderedSet sortedArrayFromRange:options:usingComparator:]//çœŸæœºçš„ç³»ç»Ÿåº“åšäº†æ··æ·†ï¼Œè¿™é‡Œå…¶å®æ˜¯__CFRunLoopLock</div><div class="line">0x0000000181521bf4 882E40F9               ldr        x8, [x20, #0x58]</div><div class="line">0x0000000181521bf8 080D40B9               ldr        w8, [x8, #0xc]</div><div class="line">0x0000000181521bfc A8010034               cbz        w8, loc_181521c30</div></pre></td></tr></table></figure>
<p>crashæ—¥å¿—ä¸­ï¼Œå´©æºƒåœ¨<code>CFRunLoopWakeUp + 92</code>ï¼Œå¯¹åº”æ±‡ç¼–åœ°å€ä¸º<code>0x0000000181521b9c + 92</code>=<code>0x0000000181521bf8</code>ï¼Œåœ¨<code>ldr        w8, [x8, #0xc]</code>çš„æ—¶å€™æŒ‚äº†ã€‚æŸ¥çœ‹crashæ—¶å¯„å­˜å™¨çš„å€¼ï¼Œ<code>x8: 0x8c8c8c8c8c8c8c8c</code>ï¼Œå¾ˆæ˜æ˜¾<code>x8</code>æŒ‡å‘çš„å†…å­˜å·²ç»è¢«é‡Šæ”¾äº†ã€‚<code>x8</code>æ˜¯ä»<code>ldr        x8, [x20, #0x58]</code>å¾—æ¥çš„ï¼ˆä¹Ÿå°±æ˜¯<code>x20</code>çš„åœ°å€åç§»<code>0x58</code>åçš„å€¼ï¼‰ï¼Œè€Œ<code>x20</code>åˆ™æ˜¯ä»<code>mov        x20, x0</code>å¾—æ¥çš„ï¼Œ<code>x0</code>å°±æ˜¯<code>CFRunloopWakeUp</code>çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œ<code>CFRunLoopRef</code>ç»“æ„ä½“ï¼Œæ‰€ä»¥<code>x8</code>å°±æ˜¯<code>CFRunLoopRef</code>åç§»<code>0x58</code>åçš„å€¼ã€‚</p>
<p><code>CoreFoundation</code>çš„ä»£ç æ˜¯å¼€æºçš„ï¼Œå¯ä»¥åœ¨è¿™é‡Œä¸‹è½½ï¼š<a href="https://opensource.apple.com/tarballs/CF/CF-1153.18.tar.gz" target="_blank" rel="external">CF-1153.18</a>ã€‚</p>
<p>å¯¹åº”<code>CFRunloopWakeUp</code>æºç ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">void CFRunLoopWakeUp(CFRunLoopRef rl) &#123;</div><div class="line">    CHECK_FOR_FORK();</div><div class="line">    __CFRunLoopLock(rl);</div><div class="line">    if (__CFRunLoopIsIgnoringWakeUps(rl)) &#123;</div><div class="line">        __CFRunLoopUnlock(rl);</div><div class="line">        return;</div><div class="line">    &#125;</div><div class="line">    kern_return_t ret;</div><div class="line">    ret = __CFSendTrivialMachMessage(rl-&gt;_wakeUpPort, 0, MACH_SEND_TIMEOUT, 0);</div><div class="line">    if (ret != MACH_MSG_SUCCESS &amp;&amp; ret != MACH_SEND_TIMED_OUT) CRASH(&quot;*** Unable to send message to wake up port. (%d) ***&quot;, ret);</div><div class="line">    __CFRunLoopUnlock(rl);</div><div class="line">&#125;</div><div class="line"></div><div class="line">CF_INLINE Boolean __CFRunLoopIsIgnoringWakeUps(CFRunLoopRef rl) &#123;</div><div class="line">    return (rl-&gt;_perRunData-&gt;ignoreWakeUps) ? true : false;    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>CFRunloopç»“æ„ä½“ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">struct __CFRunLoop &#123;</div><div class="line">    CFRuntimeBase _base;	//16 byte</div><div class="line">    pthread_mutex_t _lock;	//64 byte</div><div class="line">    __CFPort _wakeUpPort; //mach_port_t (unsign int), 4 byte</div><div class="line">    Boolean _unused;	//boolå˜é‡å ç”¨1 byteï¼Œä½†æ˜¯éœ€è¦å’Œ4å­—èŠ‚å¯¹é½ï¼Œæ‰€ä»¥ä¹Ÿæ˜¯4 byte</div><div class="line">    volatile _per_run_data *_perRunData;</div><div class="line">    pthread_t _pthread;</div><div class="line">    uint32_t _winthread;</div><div class="line">    CFMutableSetRef _commonModes;</div><div class="line">    CFMutableSetRef _commonModeItems;</div><div class="line">    CFRunLoopModeRef _currentMode;</div><div class="line">    CFMutableSetRef _modes;</div><div class="line">    struct _block_item *_blocks_head;</div><div class="line">    struct _block_item *_blocks_tail;</div><div class="line">    CFAbsoluteTime _runTime;</div><div class="line">    CFAbsoluteTime _sleepTime;</div><div class="line">    CFTypeRef _counterpart;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">typedef struct __CFRuntimeBase &#123;</div><div class="line">    uintptr_t _cfisa;	//unsigned long 8 byte</div><div class="line">    uint8_t _cfinfo[4];	//unsigned char 4 byte</div><div class="line">#if __LP64__</div><div class="line">    uint32_t _rc;	//unsigned int 4 byte</div><div class="line">#endif</div><div class="line">&#125; CFRuntimeBase;</div><div class="line"></div><div class="line">struct pthread_mutex_t &#123;</div><div class="line">truelong __sig;	//8 byte</div><div class="line">truechar __opaque[56]; //56 byte</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>è®¡ç®—ç»“æ„ä½“sizeåï¼Œå¾—å‡º<code>ldr        x8, [x20, #0x58]</code>å°±æ˜¯<code>runloop-&gt; _perRunData</code>ã€‚ä¹Ÿå°±æ˜¯åœ¨è°ƒç”¨<code>__CFRunLoopIsIgnoringWakeUps</code>çš„æ—¶å€™ï¼Œ<code>CFRunLoopRef</code>å·²ç»è¢«é‡Šæ”¾äº†ã€‚</p>
<h3 id="åˆ†æCFSocketæºç "><a href="#åˆ†æCFSocketæºç " class="headerlink" title="åˆ†æCFSocketæºç "></a>åˆ†æ<code>CFSocket</code>æºç </h3><p>æŸ¥çœ‹<code>CFSocketInvalidate</code>æºç ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">void CFSocketInvalidate(CFSocketRef s) &#123;</div><div class="line">    CHECK_FOR_FORK();</div><div class="line">    CFRetain(s);</div><div class="line">    __CFLock(&amp;__CFAllSocketsLock);</div><div class="line">    __CFSocketLock(s);</div><div class="line">    if (__CFSocketIsValid(s)) &#123;</div><div class="line">    </div><div class="line">        //çœç•¥éƒ¨åˆ†ä»£ç ...</div><div class="line"></div><div class="line">truetrue //å–å‡ºsocketä¸­çš„runloopæ•°ç»„</div><div class="line">        CFArrayRef runLoops = (CFArrayRef)CFRetain(s-&gt;_runLoops);</div><div class="line">       //CFRunloopé‡Šæ”¾æ“ä½œ1       </div><div class="line">        CFRelease(s-&gt;_runLoops);</div><div class="line">        </div><div class="line">        s-&gt;_runLoops = NULL;</div><div class="line">        </div><div class="line">        //çœç•¥éƒ¨åˆ†ä»£ç ...</div><div class="line">        </div><div class="line">        __CFSocketUnlock(s);</div><div class="line">        </div><div class="line">        // Do this after the socket unlock to avoid deadlock (10462525)</div><div class="line">        for (idx = CFArrayGetCount(runLoops); idx--;) &#123;</div><div class="line">            CFRunLoopWakeUp((CFRunLoopRef)CFArrayGetValueAtIndex(runLoops, idx));</div><div class="line">        &#125;</div><div class="line">        //CFRunloopé‡Šæ”¾æ“ä½œ3</div><div class="line">        CFRelease(runLoops);</div><div class="line"></div><div class="line">        //çœç•¥éƒ¨åˆ†ä»£ç ...</div><div class="line">    &#125; else &#123;</div><div class="line">        __CFSocketUnlock(s);</div><div class="line">    &#125;</div><div class="line">    __CFUnlock(&amp;__CFAllSocketsLock);</div><div class="line">    CFRelease(s);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>CFSocketInvalidate</code>ä¸­å”¯ä¸€ä½¿ç”¨åˆ°<code>CFRunLoopWakeUp</code>çš„åœ°æ–¹ï¼Œå°±æ˜¯æœ€åéå†runloopsçš„æ“ä½œã€‚<br>ä½†æ˜¯æ­¤æ—¶<code>CFRunLoopRef</code>è¿˜åœ¨æ•°ç»„é‡Œï¼Œæ­£åœ¨è¢«æ•°ç»„å¼ºå¼•ç”¨ï¼Œåˆ°äº†<code>CFRunLoopWakeUp</code>é‡Œæ€ä¹ˆå°±è¢«é‡Šæ”¾äº†å‘¢ï¼Ÿ</p>
<p>æ³¨æ„ï¼Œ<code>CFSocketInvalidate</code>é‡Œéå†runloopsçš„æ“ä½œæ˜¯åœ¨é”å¤–é¢è¿›è¡Œçš„ï¼Œè¯´æ˜CFSocketå¾ˆæœ‰å¯èƒ½æ²¡æœ‰ç®¡ç†å¥½å®ƒçš„runloopsæ•°ç»„ï¼Œå¯¼è‡´æ•°ç»„åœ¨éå†æ—¶è¢«é‡Šæ”¾äº†ã€‚ä»<code>Do this after the socket unlock to avoid deadlock (10462525)</code>è¿™ä¸€è¡Œæ³¨é‡ŠçŒœæµ‹ï¼Œè¿™éƒ¨åˆ†éå†æ“ä½œä¹‹å‰åº”è¯¥ä¹Ÿæ˜¯åœ¨é”å†…çš„ï¼Œä½†æ˜¯ä¼šå‡ºç°æ­»é”ï¼Œæ‰€ä»¥æ”¾åˆ°äº†é”å¤–ã€‚è‹¹æœçš„bug reportæ˜¯ä¸å¯¹å¤–å…¬å¼€çš„ï¼Œåªåœ¨è¿™é‡Œæ‰¾åˆ°äº†å¯èƒ½ç›¸å…³çš„è®¨è®ºï¼š<a href="https://bugreports.qt.io/browse/QTBUG-22789" target="_blank" rel="external">bug #10462525</a>ã€‚</p>
<p>æœ€å¤§çš„å¯èƒ½æ˜¯å‡ºç°åœ¨<code>__CFSocketCancel</code>é‡Œã€‚åœ¨runloopåœæ­¢çš„æ—¶å€™ï¼Œä¹Ÿä¼šæ‰§è¡Œremove sourceæ“ä½œï¼Œåœ¨<code>CFRunLoopRemoveSource</code>é‡Œï¼Œä¼šæ‰§è¡Œsource0çš„cancelå‡½æ•°ï¼Œä¹Ÿå°±æ˜¯<code>__CFSocketCancel</code>ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">void CFRunLoopRemoveSource(CFRunLoopRef rl, CFRunLoopSourceRef rls, CFStringRef modeName) \</div><div class="line">    CHECK_FOR_FORK();</div><div class="line">    Boolean doVer0Callout = false, doRLSRelease = false;</div><div class="line">    __CFRunLoopLock(rl);</div><div class="line">    if (modeName == kCFRunLoopCommonModes) &#123;</div><div class="line">true//çœç•¥ä»£ç ...</div><div class="line">    &#125; else &#123;</div><div class="line">trueCFRunLoopModeRef rlm = __CFRunLoopFindMode(rl, modeName, false);</div><div class="line">trueif (NULL != rlm &amp;&amp; ((NULL != rlm-&gt;_sources0 &amp;&amp; CFSetContainsValue(rlm-&gt;_sources0, rls)) || (NULL != rlm-&gt;_sources1 &amp;&amp; CFSetContainsValue(rlm-&gt;_sources1, rls)))) &#123;</div><div class="line">true    CFRetain(rls);</div><div class="line">true    //çœç•¥ä»£ç ...</div><div class="line">true    if (0 == rls-&gt;_context.version0.version) &#123;</div><div class="line">true        if (NULL != rls-&gt;_context.version0.cancel) &#123;</div><div class="line">true            doVer0Callout = true;</div><div class="line">true        &#125;</div><div class="line">true    &#125;</div><div class="line">true    doRLSRelease = true;</div><div class="line">true&#125;</div><div class="line">        //çœç•¥ä»£ç ...</div><div class="line">true&#125;</div><div class="line">    &#125;</div><div class="line">    __CFRunLoopUnlock(rl);</div><div class="line">    if (doVer0Callout) &#123;</div><div class="line">        // although it looses some protection for the source, we have no choice but</div><div class="line">        // to do this after unlocking the run loop and mode locks, to avoid deadlocks</div><div class="line">        // where the source wants to take a lock which is already held in another</div><div class="line">        // thread which is itself waiting for a run loop/mode lock</div><div class="line">        rls-&gt;_context.version0.cancel(rls-&gt;_context.version0.info, rl, modeName);	/* CALLOUT */</div><div class="line">    &#125;</div><div class="line">    if (doRLSRelease) CFRelease(rls);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>__CFSocketCancel</code>æºç ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">static void __CFSocketCancel(void *info, CFRunLoopRef rl, CFStringRef mode) &#123;</div><div class="line">    CFSocketRef s = (CFSocketRef)info;</div><div class="line">    __CFSocketLock(s);</div><div class="line">    if (0 == s-&gt;_socketSetCount) &#123;</div><div class="line">        //çœç•¥ä»£ç ...</div><div class="line">    if (NULL != s-&gt;_runLoops) &#123;</div><div class="line">    //ä»runloopsæ•°ç»„ä¸­ç§»é™¤æ­¤runloopï¼›å¯¹åŸæ•°ç»„æ‰§è¡Œæ‹·è´åï¼Œé‡Šæ”¾åŸæ•°ç»„</div><div class="line">        CFMutableArrayRef runLoopsOrig = s-&gt;_runLoops;</div><div class="line">        CFMutableArrayRef runLoopsCopy = CFArrayCreateMutableCopy(kCFAllocatorSystemDefault, 0, s-&gt;_runLoops);</div><div class="line">        idx = CFArrayGetFirstIndexOfValue(runLoopsCopy, CFRangeMake(0, CFArrayGetCount(runLoopsCopy)), rl);</div><div class="line">        if (0 &lt;= idx) CFArrayRemoveValueAtIndex(runLoopsCopy, idx);</div><div class="line">        s-&gt;_runLoops = runLoopsCopy;</div><div class="line">        //CFRunloopé‡Šæ”¾æ“ä½œ2</div><div class="line">        CFRelease(runLoopsOrig);</div><div class="line">    &#125;</div><div class="line">    __CFSocketUnlock(s);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>__CFSocketCancel</code>ä¹Ÿæœ‰ä¸€æ¬¡å¯¹<code>CFRunloopRef</code>çš„é‡Šæ”¾æ“ä½œï¼ŒåŠ ä¸Š<code>CFSocketInvalidate</code>é‡Œçš„2ä¸ªï¼Œæ€»å…±æœ‰3ä¸ªé‡Šæ”¾æ“ä½œã€‚</p>
<p>æ‰€ä»¥ï¼Œå¦‚æœ<code>__CFSocketCancel</code>å’Œ<code>CFSocketInvalidate</code>åœ¨å¤šçº¿ç¨‹åŒæ—¶æ‰§è¡Œï¼Œå°±æœ‰å¯èƒ½å‡ºç°å¯¹CFSocketä¸­çš„runloopsæ•°ç»„è¿‡åº¦é‡Šæ”¾ï¼Œå› æ­¤åœ¨éå†runloopsçš„æ—¶å€™å°±ä¼šå‡ºç°<code>CFRunLoopRef</code>è¢«é‡Šæ”¾çš„æƒ…å†µã€‚è™½ç„¶è¿™ä¸ªcrashå‡ºç°çš„æ¦‚ç‡æ¯”è¾ƒä½ï¼Œä½†æ˜¯åœ¨é¡¹ç›®é‡Œéš”ä¸€æ®µæ—¶é—´å°±ä¼šç¨³å®šå‡ºç°ã€‚</p>
<p>æ‰€ä»¥ï¼Œä¸æ˜¯åŠ äº†é”å°±ä¸‡äº‹å¤§å‰äº†ï¼Œ<code>CFSocketInvalidate</code>é‡Œåœ¨éå†æ•°ç»„å‰åº”è¯¥å†åŠ ä¸€ä¸ªretainæ‰èƒ½ä¿è¯å®‰å…¨ã€‚</p>
<h3 id="è§£å†³æ–¹æ³•"><a href="#è§£å†³æ–¹æ³•" class="headerlink" title="è§£å†³æ–¹æ³•"></a>è§£å†³æ–¹æ³•</h3><ul>
<li>æ—¢ç„¶æ˜¯CFSocketé‡Œçš„bugï¼Œé‚£å°±åªèƒ½é¿å…ä¸è¦å‡ºç°<code>CFSocketInvalidate</code>å’Œ<code>CFRunloopStop</code>å¤šçº¿ç¨‹æ‰§è¡Œçš„ä»£ç ã€‚</li>
<li>å¦‚æœä½ çš„socketåªåœ¨è¿™ä¸ªçº¿ç¨‹é‡Œè¿è¡Œï¼Œé‚£ç›´æ¥è°ƒç”¨<code>CFRunloopStop</code>å³å¯ï¼Œrunloopä¼šè‡ªåŠ¨æ¸…ç†æ‰€æœ‰sourceã€‚</li>
<li>å¦‚æœè¿™ä¸ªçº¿ç¨‹éœ€è¦é‡ç”¨ï¼Œé‚£å°±ä¸éœ€è¦stopï¼Œè€Œæ˜¯åœæ­¢socketåï¼Œåœ¨åŒä¸€ä¸ªçº¿ç¨‹é‡Œæ–°å»ºsocketã€‚</li>
</ul>
<h2 id="è‡ªåŠ¨åœæ­¢çš„Runloop"><a href="#è‡ªåŠ¨åœæ­¢çš„Runloop" class="headerlink" title="è‡ªåŠ¨åœæ­¢çš„Runloop"></a>è‡ªåŠ¨åœæ­¢çš„Runloop</h2><p>é‚£ä¹ˆï¼Œå¦‚æœæŠŠstopä»£ç æ”¹æˆè¿™æ ·ï¼Œåº”è¯¥å°±æ²¡é—®é¢˜äº†å§ï¼Ÿ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">- (void)runThread &#123;</div><div class="line">    @autoreleasepool &#123;</div><div class="line">        self.currentRunloop = CFRunLoopGetCurrent();</div><div class="line">        [self addRunloopSource];</div><div class="line">        [self addSocketSource];</div><div class="line">        </div><div class="line">        CFRunLoopRun();</div><div class="line">    &#125;</div><div class="line">    NSLog(@&quot;çº¿ç¨‹é€€å‡º&quot;);</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (void)stopThread &#123;</div><div class="line">    if (_currentRunloop) &#123;</div><div class="line">true    //ä¿è¯removeSocketSourceçš„æ“ä½œåªä¼šåœ¨è¿™é‡Œæ‰§è¡Œï¼Œæ²¡æœ‰å¤šçº¿ç¨‹çš„æƒ…å†µ</div><div class="line">        [self removeSocketSource];</div><div class="line">        CFRunLoopStop(_currentRunloop);</div><div class="line">        self.currentRunloop = NULL;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¾ˆé—æ†¾ï¼Œè¿™æ ·å†™è¿˜æ˜¯ä¸å®‰å…¨çš„ã€‚</p>
<p>åŸå› åœ¨äº<code>removeSocketSource</code>ä¹‹åï¼Œrunloopé‡Œsourceå°±å…¨éƒ¨ä¸ºç©ºäº†ï¼Œrunloopå¦‚æœæ£€æµ‹åˆ°äº†sourceä¸ºç©ºï¼Œå°±ä¼šè‡ªåŠ¨åœæ­¢runloopå¾ªç¯ï¼Œé”€æ¯çº¿ç¨‹ã€‚</p>
<p>å› æ­¤å¦‚æœä½ åœ¨å¦ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨<code>stopThread</code>ï¼Œåœ¨<code>removeSocketSource</code>ä¹‹åçº¿ç¨‹å°±ä¼šéšæ—¶åœæ­¢ï¼Œrunloopåœ¨è°ƒç”¨<code>CFRunLoopStop</code>æ—¶å¯èƒ½å·²ç»è¢«é‡Šæ”¾äº†ã€‚</p>
<p>ä¸Šé¢çš„å†™æ³•å‡ºç°crashçš„æ¦‚ç‡å¤ªä½ï¼Œä½†æ˜¯ç¨å¾®æ”¹ä¸€ä¸‹å°±èƒ½å¿…ç°ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">- (void)stopThread &#123;</div><div class="line">    if (_currentRunloop) &#123;</div><div class="line">        [self removeSocketSource];</div><div class="line">        </div><div class="line">        //æ’å…¥ä¸€ä¸ªè€—æ—¶æ“ä½œ</div><div class="line">        sleep(2);</div><div class="line">        //å¿…å®šcrash</div><div class="line">        CFRunLoopStop(_currentRunloop);</div><div class="line">        self.currentRunloop = NULL;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™ç§æƒ…å†µä¸‹crashçš„åŸå› å…¶å®æ˜¯æ²¡åšå¥½å†…å­˜ç®¡ç†ï¼Œåªè¦å¯¹runloopå¢åŠ ä¸€æ¬¡retainæ“ä½œå°±æ²¡é—®é¢˜äº†ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">- (void)runThread &#123;</div><div class="line">    @autoreleasepool &#123;</div><div class="line">true    //åšä¸€æ¬¡retainæ“ä½œ</div><div class="line">        self.currentRunloop = CFRetain(CFRunLoopGetCurrent());</div><div class="line">        [self addRunloopSource];</div><div class="line">        [self addSocketSource];</div><div class="line">        </div><div class="line">        CFRunLoopRun();</div><div class="line">    &#125;</div><div class="line">    NSLog(@&quot;çº¿ç¨‹é€€å‡º&quot;);</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (void)stopThread &#123;</div><div class="line">    if (_currentRunloop) &#123;</div><div class="line">        [self removeSocketSource];</div><div class="line">        CFRunLoopStop(_currentRunloop);</div><div class="line">        CFRelease(_currentRunloop);</div><div class="line">        self.currentRunloop = NULL;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="ç»“è®º"><a href="#ç»“è®º" class="headerlink" title="ç»“è®º"></a>ç»“è®º</h2><p>åœ¨ä½¿ç”¨runloop sourceçš„æ—¶å€™è¦è°¨æ…ï¼Œå°¤å…¶åœ¨å¤„ç†stopçš„é˜¶æ®µã€‚å…¶ä»–sourceå¯èƒ½ä¹Ÿå­˜åœ¨ç±»ä¼¼çš„é—®é¢˜ã€‚</p>
<p>ä¸€ä¸ªå˜é‡æœ‰å¤šçº¿ç¨‹æ“ä½œçš„æ—¶å€™ï¼Œåœ¨é”å¤–çš„æ“ä½œå³ä½¿æ˜¯åªè¯»ä¹Ÿæ˜¯ä¸å®‰å…¨çš„ï¼Œåœ¨è¯»å–ä¹‹å‰æœ€å¥½å†åšä¸€æ¬¡retainæ“ä½œï¼Œé˜²æ­¢åœ¨è¯»å–çš„è¿‡ç¨‹ä¸­è¢«é‡Šæ”¾ã€‚</p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/iOS/" rel="tag">#iOS</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/05/04/iOSé€†å‘ï¼šåœ¨ä»»æ„appä¸Šå¼€å¯malloc stackè¿½è¸ªå†…å­˜æ¥æº/" rel="next" title="iOSé€†å‘ï¼šåœ¨ä»»æ„appä¸Šå¼€å¯malloc stackè¿½è¸ªå†…å­˜æ¥æº">
                <i class="fa fa-chevron-left"></i> iOSé€†å‘ï¼šåœ¨ä»»æ„appä¸Šå¼€å¯malloc stackè¿½è¸ªå†…å­˜æ¥æº
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/07/21/iOS VIPERæ¶æ„å®è·µ(ä¸€)ï¼šä»MVCåˆ°MVVMåˆ°VIPER/" rel="prev" title="iOS VIPERæ¶æ„å®è·µ(ä¸€)ï¼šä»MVCåˆ°MVVMåˆ°VIPER">
                iOS VIPERæ¶æ„å®è·µ(ä¸€)ï¼šä»MVCåˆ°MVVMåˆ°VIPER <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          

          
  <div class="comments" id="comments">
    
      <div id="gitalk-container"></div>
      <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            æ–‡ç« ç›®å½•
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            ç«™ç‚¹æ¦‚è§ˆ
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.jpg"
               alt="zuik" />
          <p class="site-author-name" itemprop="name">zuik</p>
          <p class="site-description motion-element" itemprop="description">zuikxyo@gmail.comğŸ¼https://github.com/Zuikyo</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">13</span>
              <span class="site-state-item-name">æ—¥å¿—</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">7</span>
                <span class="site-state-item-name">åˆ†ç±»</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">1</span>
                <span class="site-state-item-name">æ ‡ç­¾</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#ä¸å®‰å…¨çš„CFRunloopSource"><span class="nav-number">1.</span> <span class="nav-text">ä¸å®‰å…¨çš„CFRunloopSource</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ç¤ºä¾‹ä»£ç "><span class="nav-number">1.1.</span> <span class="nav-text">ç¤ºä¾‹ä»£ç </span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#crashå®ä¾‹åˆ†æ"><span class="nav-number">1.2.</span> <span class="nav-text">crashå®ä¾‹åˆ†æ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#åˆ†æCFSocketæºç "><span class="nav-number">1.3.</span> <span class="nav-text">åˆ†æCFSocketæºç </span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#è§£å†³æ–¹æ³•"><span class="nav-number">1.4.</span> <span class="nav-text">è§£å†³æ–¹æ³•</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#è‡ªåŠ¨åœæ­¢çš„Runloop"><span class="nav-number">2.</span> <span class="nav-text">è‡ªåŠ¨åœæ­¢çš„Runloop</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ç»“è®º"><span class="nav-number">3.</span> <span class="nav-text">ç»“è®º</span></a></li></ol></div>
            
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">zuik</span>
</div>

<div class="powered-by">
  ç”± <a class="theme-link" href="https://hexo.io">Hexo</a> å¼ºåŠ›é©±åŠ¨
</div>

<div class="theme-info">
  ä¸»é¢˜ -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>

<script>
(function(){
var bp = document.createElement('script');
bp.src = '//zz.bdstatic.com/linksubmit/push.js';
var s = document.getElementsByTagName("script")[0];
s.parentNode.insertBefore(bp, s);
})();
</script>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/libs/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/libs/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/libs/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/libs/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/libs/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/libs/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.0.1"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.0.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.0.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  



  




  
    
      <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
      <script type="text/javascript">
        const gitalk = new Gitalk({
          clientID: '348b65b1168d7aa48b08',
          clientSecret: '6a87660b699abe603eac61c471ab5781fd27fc03',
          repo: 'Zuikyo.github.io',
          owner: 'Zuikyo',
          admin: 'Zuikyo'.split(','),
          id: '1495441769000',
          pagerDirection: 'first',
          // facebook-like distraction free mode
          distractionFreeMode: false
        })
        gitalk.render('gitalk-container')
      </script>
    
  

  
  

  

  

  

</body>
</html>
